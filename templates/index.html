<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Knowledge Base</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 16px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-selector:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }

        .user-selector:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 14px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover {
            color: var(--text-primary);
        }

        /* Notes Grid */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .note-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .note-card:hover::before {
            transform: scaleX(1);
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .note-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .note-content {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
            max-height: 100px;
            overflow: hidden;
        }

        .note-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .tag {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge {
            background: rgba(139, 92, 246, 0.2);
            color: var(--secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .note-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .icon-btn.active {
            color: var(--warning);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Lists */
        .reminder-list, .history-list, .collab-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .list-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item-info h4 {
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .list-item-info p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .list-item.notebook-item {
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .list-item.notebook-item:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }

        .list-item.notebook-item.active {
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
        }

        .notebook-layout {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .notebook-column {
            flex: 1 1 320px;
        }

        .notebook-notes-panel {
            flex: 2 1 500px;
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        .notebook-notes-panel.active {
            display: flex;
        }

        .notebook-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Section */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confidence-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .notes-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">üìö Knowledge Base Pro</div>
            <div class="header-actions">
                <select class="user-selector" id="userSelector" onchange="switchUser()">
                    <option value="">Loading users...</option>
                </select>
                <button class="btn btn-primary" onclick="openNoteModal()">
                    ‚úçÔ∏è New Note
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Dashboard -->
        <div class="stats-grid" id="stats">
            <div class="stat-card" id="cardTotalNotes">
                <div class="stat-value" id="totalNotes">0</div>
                <div class="stat-label">Total Notes</div>
            </div>
            <div class="stat-card" id="cardNotebooks">
                <div class="stat-value" id="totalNotebooks">0</div>
                <div class="stat-label">Notebooks</div>
            </div>
            <div class="stat-card" id="cardPendingReminders">
                <div class="stat-value" id="pendingReminders">0</div>
                <div class="stat-label">Pending Reminders</div>
            </div>
            <div class="stat-card" id="cardBookmarks">
                <div class="stat-value" id="totalBookmarks">0</div>
                <div class="stat-label">Bookmarks</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('notes', event)">üìù All Notes</button>
            <button class="tab" onclick="switchTab('notebooks', event)">üìí Notebooks</button>
            <button class="tab" onclick="switchTab('bookmarks', event)">‚≠ê Bookmarks</button>
            <button class="tab" onclick="switchTab('reminders', event)">‚è∞ Reminders</button>
        </div>

        <!-- Content Areas -->
        <div id="notesContent">
            <div class="notes-grid" id="notesGrid"></div>
        </div>

        <div id="bookmarksContent" style="display: none;">
            <div class="notes-grid" id="bookmarksGrid"></div>
        </div>

        <div id="remindersContent" style="display: none;">
            <div class="reminder-list" id="remindersList"></div>
        </div>

        <div id="notebooksContent" style="display: none;">
            <div class="notebook-layout">
                <div class="notebook-column section" style="flex: 1 1 320px;">
                    <h3 class="section-title" style="margin-top: 0;">üìö Your Notebooks</h3>
                    <div class="reminder-list" id="notebooksList"></div>
                </div>
                <div class="notebook-column section notebook-notes-panel" id="notebookNotesWrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h3 class="section-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                            üìí Notes in <span id="selectedNotebookTitle" style="color: var(--primary);"></span>
                        </h3>
                        <button class="btn btn-secondary btn-sm" onclick="clearNotebookSelection()" id="clearNotebookBtn" style="display: none;">Clear Selection</button>
                    </div>
                    <div id="notebookNotesEmpty" class="notebook-empty" style="display: none;">
                        <div class="empty-state-icon">üîç</div>
                        <p>No notes in this notebook yet.</p>
                    </div>
                    <div class="notes-grid" id="notebookNotesGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Create New Note</h2>
                <button class="close-btn" onclick="closeNoteModal()">&times;</button>
            </div>
            <form id="noteForm">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="noteTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-textarea" id="noteContent" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="noteCategory">
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notebook</label>
                    <select class="form-select" id="noteNotebook">
                        <option value="">Select Notebook</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma separated)</label>
                    <input type="text" class="form-input" id="noteTags" placeholder="sql, mysql, design, todo">
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        üí° Add 'todo' tag to auto-create a reminder (Trigger: trg_auto_todo_reminder)
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="notePublic">
                        <span>Make this note public</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Note</button>
                    <button type="button" class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Note Details Modal -->
    <div class="modal" id="noteDetailsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="detailsTitle">Note Details</h2>
                <button class="close-btn" onclick="closeDetailsModal()">&times;</button>
            </div>
            
            <div id="noteDetailsContent"></div>

            <!-- Version History Section -->
            <div class="section">
                <div class="section-title">
                    üìú Version History
                    <small style="color: var(--text-secondary); font-weight: 400; font-size: 12px;">
                        (Trigger: trg_note_version)
                    </small>
                </div>
                <div class="history-list" id="historyList"></div>
            </div>

            <!-- Tag Suggestions Section -->
            <div class="section">
                <div class="section-title">
                    üè∑Ô∏è AI Tag Suggestions
                    <div style="display: flex; gap: 10px; margin-left: auto;">
                        <button class="btn btn-sm btn-primary" id="aiSuggestBtn" onclick="aiSuggestTags()" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            ü§ñ Auto-Suggest with AI
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="showSuggestTagForm()">+ Manual Suggest</button>
                    </div>
                </div>
                <div id="aiStatus" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; background: rgba(99, 102, 241, 0.1); display: none;"></div>
                <div id="tagSuggestions"></div>
                <div id="suggestTagForm" style="display: none; margin-top: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <select class="form-select" id="suggestTagId" style="flex: 1;">
                            <option value="">Select Tag</option>
                        </select>
                        <input type="number" class="form-input" id="suggestConfidence" 
                               placeholder="Confidence (0-1)" step="0.01" min="0" max="1" value="0.85" 
                               style="width: 150px;">
                        <button class="btn btn-success btn-sm" onclick="suggestTag()">Suggest</button>
                    </div>
                </div>
            </div>

            <!-- Collaboration Section -->
            <div class="section">
                <div class="section-title">
                    üë• Collaborators
                    <button class="btn btn-sm btn-secondary" onclick="showShareForm()">+ Share Note</button>
                </div>
                <div class="collab-list" id="collabList"></div>
                <div id="shareForm" style="display: none; margin-top: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <select class="form-select" id="shareUserId" style="flex: 1;">
                            <option value="">Select User</option>
                        </select>
                        <select class="form-select" id="shareAccessLevel" style="width: 150px;">
                            <option value="read">Read</option>
                            <option value="write">Write</option>
                            <option value="owner">Owner</option>
                        </select>
                        <button class="btn btn-success btn-sm" onclick="shareNote()">Share</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'notes';
        let currentNoteId = null;
        let viewingNoteId = null;
        let selectedNotebookId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('App initialized');
            testConnection();
            loadUsers().then(() => {
                loadStats();
                loadNotes();
                loadCategories();
                loadNotebooks();
                loadNotebooksList();
                loadAllTags();
            });

            // Click handlers for stat cards
            document.getElementById('cardTotalNotes').addEventListener('click', () => {
                activateTabButton('notes');
                showOnly('notesContent');
                loadNotes();
            });
            document.getElementById('cardNotebooks').addEventListener('click', () => {
                activateTabButton('notebooks');
                showOnly('notebooksContent');
                loadNotebooksList();
            });
            document.getElementById('cardPendingReminders').addEventListener('click', () => {
                activateTabButton('reminders');
                showOnly('remindersContent');
                loadReminders('pending');
            });
            document.getElementById('cardBookmarks').addEventListener('click', () => {
                activateTabButton('bookmarks');
                showOnly('bookmarksContent');
                loadBookmarks();
            });
        });

        // Test database connection
        async function testConnection() {
            try {
                const response = await fetch('/api/debug/test-connection');
                const data = await response.json();
                console.log('Database connection test:', data);
            } catch (error) {
                console.error('Connection test failed:', error);
            }
        }

        // Switch Tabs
        function switchTab(tab, event) {
            currentTab = tab;
            if (event) activateTabButton(tab);
            showOnly(tab === 'notes' ? 'notesContent' : tab === 'bookmarks' ? 'bookmarksContent' : tab === 'reminders' ? 'remindersContent' : 'notebooksContent');

            if (tab === 'notes') loadNotes();
            else if (tab === 'bookmarks') loadBookmarks();
            else if (tab === 'reminders') loadReminders();
            else if (tab === 'notebooks') loadNotebooksList(true);
        }

        function activateTabButton(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const mapping = { notes: 0, notebooks: 1, bookmarks: 2, reminders: 3 };
            const tabs = document.querySelectorAll('.tab');
            if (tabs[mapping[tab]]) tabs[mapping[tab]].classList.add('active');
        }

        function showOnly(contentId) {
            document.getElementById('notesContent').style.display = 'none';
            document.getElementById('bookmarksContent').style.display = 'none';
            document.getElementById('remindersContent').style.display = 'none';
            document.getElementById('notebooksContent').style.display = 'none';
            document.getElementById(contentId).style.display = 'block';
        }

        // Load Stats
        async function loadStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            document.getElementById('totalNotes').textContent = stats.total_notes;
            document.getElementById('totalNotebooks').textContent = stats.total_notebooks;
            document.getElementById('pendingReminders').textContent = stats.pending_reminders;
            document.getElementById('totalBookmarks').textContent = stats.total_bookmarks;
        }

        function renderNoteCard(note) {
            const isOwner = note.note_type === 'owner';
            const isShared = note.note_type === 'shared';
            const hasWriteAccess = note.access_level === 'write' || note.access_level === 'owner';
            const canEdit = isOwner || (isShared && hasWriteAccess);
            const canDelete = isOwner;

            return `
                <div class="note-card">
                    <div class="note-header">
                        <div style="flex: 1;" onclick="viewNoteDetails(${note.note_id})">
                            <h3 class="note-title">${note.title}</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px;">
                                ${note.category ? `<span class="badge">${note.category}</span>` : ''}
                                ${isShared ? `<span class="badge" style="background: rgba(139, 92, 246, 0.3); color: var(--secondary);">üë• Shared (${note.access_level})</span>` : ''}
                            </div>
                        </div>
                        <div class="note-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn ${note.is_bookmarked ? 'active' : ''}" 
                                    onclick="toggleBookmark(${note.note_id})" 
                                    title="Bookmark">‚≠ê</button>
                            ${canEdit ? `
                                <button class="icon-btn" onclick="editNote(${note.note_id})" title="Edit">‚úèÔ∏è</button>
                            ` : ''}
                            ${canDelete ? `
                                <button class="icon-btn" onclick="deleteNote(${note.note_id})" title="Delete">üóëÔ∏è</button>
                            ` : ''}
                        </div>
                    </div>
                    <p class="note-content" onclick="viewNoteDetails(${note.note_id})">${note.content}</p>
                    <div class="note-meta">
                        ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        <span style="margin-left: auto; color: var(--text-secondary); font-size: 12px;">
                            ${note.updated_at}
                        </span>
                    </div>
                </div>
            `;
        }

        // Load Notes
        async function loadNotes() {
            const response = await fetch('/api/notes');
            const notes = await response.json();
            const grid = document.getElementById('notesGrid');
            
            if (notes.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No notes yet. Create your first note!</p></div>';
                return;
            }
            
            grid.innerHTML = notes.map(renderNoteCard).join('');
        }

        // View Note Details
        async function viewNoteDetails(noteId) {
            viewingNoteId = noteId;
            const response = await fetch(`/api/notes/${noteId}`);
            const note = await response.json();
            
            document.getElementById('detailsTitle').textContent = note.title;
            document.getElementById('noteDetailsContent').innerHTML = `
                <div style="background: var(--bg-dark); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <p style="white-space: pre-wrap; line-height: 1.6;">${note.content}</p>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
            
            loadNoteHistory(noteId);
            loadTagSuggestions(noteId);
            loadCollaborators(noteId);
            checkAIStatus(); // Check AI availability when viewing note
            
            document.getElementById('noteDetailsModal').classList.add('active');
        }

        function closeDetailsModal() {
            document.getElementById('noteDetailsModal').classList.remove('active');
            viewingNoteId = null;
        }

        // Load Note History (from trg_note_version trigger)
        async function loadNoteHistory(noteId) {
            const response = await fetch(`/api/notes/${noteId}/history`);
            const history = await response.json();
            const list = document.getElementById('historyList');
            
            if (history.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No version history yet. Edit the note to create history.</p>';
                return;
            }
            
            list.innerHTML = history.map(h => `
                <div class="list-item">
                    <div class="list-item-info">
                        <h4>${h.title}</h4>
                        <p>${h.content.substring(0, 100)}... ‚Ä¢ Edited by ${h.edited_by} on ${h.version_at}</p>
                    </div>
                </div>
            `).join('');
        }

        // Tag Suggestions (Procedure: suggest_tag)
        async function loadTagSuggestions(noteId) {
            const response = await fetch(`/api/notes/${noteId}/tag-suggestions`);
            const suggestions = await response.json();
            const container = document.getElementById('tagSuggestions');
            
            if (suggestions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No tag suggestions yet.</p>';
                return;
            }
            
            container.innerHTML = suggestions.map(s => `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span class="tag">${s.tag_name}</span>
                    <span class="confidence-badge">${(s.confidence * 100).toFixed(0)}% confidence</span>
                    <span style="color: var(--text-secondary); font-size: 12px;">${s.suggested_at}</span>
                </div>
            `).join('');
        }

        function showSuggestTagForm() {
            document.getElementById('suggestTagForm').style.display = 'block';
        }

        async function suggestTag() {
            const tagId = document.getElementById('suggestTagId').value;
            const confidence = document.getElementById('suggestConfidence').value;
            
            if (!tagId) {
                alert('Please select a tag');
                return;
            }
            
            await fetch(`/api/notes/${viewingNoteId}/suggest-tag`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tag_id: parseInt(tagId), confidence: parseFloat(confidence) })
            });
            
            document.getElementById('suggestTagForm').style.display = 'none';
            loadTagSuggestions(viewingNoteId);
        }

        // AI-Powered Tag Suggestions (Gemini)
        async function checkAIStatus() {
            try {
                const response = await fetch('/api/ai-status');
                const status = await response.json();
                const statusDiv = document.getElementById('aiStatus');
                const aiBtn = document.getElementById('aiSuggestBtn');
                
                if (status.available) {
                    statusDiv.style.display = 'none';
                    if (aiBtn) aiBtn.disabled = false;
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `<span style="color: var(--warning);">‚ö†Ô∏è ${status.message}</span>`;
                    if (aiBtn) aiBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error checking AI status:', error);
            }
        }

        async function aiSuggestTags() {
            if (!viewingNoteId) {
                alert('Please open a note first');
                return;
            }

            const aiBtn = document.getElementById('aiSuggestBtn');
            const statusDiv = document.getElementById('aiStatus');
            
            // Show loading state
            const originalText = aiBtn.textContent;
            aiBtn.disabled = true;
            aiBtn.textContent = 'ü§ñ Analyzing with AI...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span style="color: var(--primary);">ü§ñ AI is analyzing your note content...</span>';

            try {
                const response = await fetch(`/api/notes/${viewingNoteId}/ai-suggest-tags`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.suggestions && result.suggestions.length > 0) {
                        statusDiv.innerHTML = `<span style="color: var(--success);">‚úì ${result.message}</span>`;
                        // Reload tag suggestions to show the new ones
                        loadTagSuggestions(viewingNoteId);
                        
                        // Show success message with details
                        const tagNames = result.suggestions.map(s => s.tag_name).join(', ');
                        setTimeout(() => {
                            alert(`‚úì AI generated ${result.suggestions.length} tag suggestions:\n\n${tagNames}\n\nCheck the suggestions below!`);
                        }, 500);
                    } else {
                        statusDiv.innerHTML = '<span style="color: var(--text-secondary);">‚ÑπÔ∏è ' + result.message + '</span>';
                    }
                } else {
                    statusDiv.innerHTML = `<span style="color: var(--danger);">‚úó ${result.error || 'Error generating suggestions'}</span>`;
                    if (!result.available) {
                        alert('AI service is not available. Please set the GEMINI_API_KEY environment variable.\n\nSee README for setup instructions.');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<span style="color: var(--danger);">‚úó Error: ${error.message}</span>`;
                alert('Failed to generate AI suggestions. Please try again.');
            } finally {
                aiBtn.disabled = false;
                aiBtn.textContent = originalText;
            }
        }

        // Collaboration (Procedure: share_note)
        async function loadCollaborators(noteId) {
            const response = await fetch(`/api/notes/${noteId}/collaborators`);
            const collabs = await response.json();
            const list = document.getElementById('collabList');
            
            if (collabs.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No collaborators yet. Share this note with others!</p>';
                return;
            }
            
            list.innerHTML = collabs.map(c => `
                <div class="list-item">
                    <div class="list-item-info">
                        <h4>${c.name} (${c.email})</h4>
                        <p>Access: <strong>${c.access_level}</strong> ‚Ä¢ Shared ${c.shared_at}</p>
                    </div>
                </div>
            `).join('');
        }

        function showShareForm() {
            document.getElementById('shareForm').style.display = 'block';
        }

        async function shareNote() {
            const userId = document.getElementById('shareUserId').value;
            const accessLevel = document.getElementById('shareAccessLevel').value;
            
            if (!userId) {
                alert('Please select a user');
                return;
            }
            
            const response = await fetch(`/api/notes/${viewingNoteId}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: parseInt(userId), access_level: accessLevel })
            });
            
            const result = await response.json();
            
            document.getElementById('shareForm').style.display = 'none';
            loadCollaborators(viewingNoteId);
            
            // Get user name for the message
            const userSelect = document.getElementById('shareUserId');
            const selectedOption = userSelect.options[userSelect.selectedIndex];
            const userName = selectedOption.text.split(' (')[0];
            
            alert(`‚úì Note shared successfully with ${userName}!\n\nThey will see this note in their notes list when they switch to their account.`);
        }

        // Load Categories
        async function loadCategories() {
            const response = await fetch('/api/categories');
            const categories = await response.json();
            const select = document.getElementById('noteCategory');
            select.innerHTML = '<option value="">Select Category</option>' +
                categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // Load Notebooks
        async function loadNotebooks() {
            const response = await fetch('/api/notebooks');
            const notebooks = await response.json();
            const select = document.getElementById('noteNotebook');
            select.innerHTML = '<option value="">Select Notebook</option>' +
                notebooks.map(n => `<option value="${n.id}">${n.title}</option>`).join('');
        }

        // Load Users for Sharing
        async function loadUsers() {
            const response = await fetch('/api/users');
            const users = await response.json();
            const select = document.getElementById('shareUserId');
            select.innerHTML = '<option value="">Select User</option>' +
                users.map(u => `<option value="${u.id}">${u.name} (${u.email})</option>`).join('');
            
            // Also populate user selector in header
            const userSelector = document.getElementById('userSelector');
            if (userSelector) {
                userSelector.innerHTML = users.map(u => 
                    `<option value="${u.id}">${u.name} (${u.email})</option>`
                ).join('');
                
                // Set current user after populating
                const currentUserResponse = await fetch('/api/current-user');
                const currentUser = await currentUserResponse.json();
                userSelector.value = currentUser.id;
            }
        }

        // Load Current User (called separately if needed)
        async function loadCurrentUser() {
            const response = await fetch('/api/current-user');
            const user = await response.json();
            const userSelector = document.getElementById('userSelector');
            if (userSelector && userSelector.options.length > 0) {
                userSelector.value = user.id;
            }
        }

        // Switch User
        async function switchUser() {
            const userSelector = document.getElementById('userSelector');
            const userId = parseInt(userSelector.value);
            
            if (!userId) return;
            
            const response = await fetch('/api/set-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Reload all data for the new user
                loadStats();
                loadNotes();
                loadNotebooks();
                loadBookmarks();
                loadReminders();
                alert(`‚úì Switched to ${result.message}`);
            } else {
                alert('Failed to switch user');
            }
        }

        // Load All Tags for Suggestions
        async function loadAllTags() {
            const response = await fetch('/api/tags');
            const tags = await response.json();
            const select = document.getElementById('suggestTagId');
            select.innerHTML = '<option value="">Select Tag</option>' +
                tags.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        // Load Bookmarks
        async function loadBookmarks() {
            const response = await fetch('/api/bookmarks');
            const bookmarks = await response.json();
            const grid = document.getElementById('bookmarksGrid');
            
            if (bookmarks.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><p>No bookmarks yet. Star your favorite notes!</p></div>';
                return;
            }
            
            grid.innerHTML = bookmarks.map(note => `
                <div class="note-card" onclick="viewNoteDetails(${note.note_id})">
                    <h3 class="note-title">${note.title}</h3>
                    <p class="note-content">${note.content}</p>
                    <div style="margin-top: 15px; color: var(--text-secondary); font-size: 12px;">
                        Bookmarked: ${note.bookmarked_at}
                    </div>
                </div>
            `).join('');
        }

        // Load Reminders
        async function loadReminders(status) {
            const url = status ? `/api/reminders?status=${encodeURIComponent(status)}` : '/api/reminders';
            const response = await fetch(url);
            const reminders = await response.json();
            const list = document.getElementById('remindersList');
            
            if (reminders.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è∞</div><p>No reminders. Add "todo" tag to create auto-reminders!</p></div>';
                return;
            }
            
            list.innerHTML = reminders.map(r => `
                <div class="list-item" style="${r.status === 'done' ? 'opacity: 0.5;' : ''}">
                    <div class="list-item-info">
                        <h4>${r.text}</h4>
                        <p>üìå ${r.note_title} ‚Ä¢ Due: ${r.due_date} ‚Ä¢ Status: <strong>${r.status}</strong></p>
                    </div>
                    ${r.status === 'pending' ? `
                        <button class="btn btn-success btn-sm" onclick="markReminderDone(${r.id})">
                            ‚úì Mark Done
                        </button>
                    ` : '<span class="badge">‚úì Completed</span>'}
                </div>
            `).join('');
        }

        // List Notebooks
        async function loadNotebooksList(preserveSelection = false) {
            const response = await fetch('/api/notebooks');
            const notebooks = await response.json();
            const list = document.getElementById('notebooksList');
            const notesWrapper = document.getElementById('notebookNotesWrapper');
            const clearBtn = document.getElementById('clearNotebookBtn');
            const notesGrid = document.getElementById('notebookNotesGrid');
            const emptyState = document.getElementById('notebookNotesEmpty');
            const selectedTitle = document.getElementById('selectedNotebookTitle');

            if (notebooks.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìí</div><p>No notebooks found.</p></div>';
                notesWrapper.classList.remove('active');
                clearBtn.style.display = 'none';
                notesGrid.innerHTML = '';
                emptyState.style.display = 'none';
                selectedTitle.textContent = '';
                selectedNotebookId = null;
                return;
            }

            list.innerHTML = notebooks.map(n => `
                <div class="list-item notebook-item ${selectedNotebookId === n.id ? 'active' : ''}" 
                     data-notebook-id="${n.id}"
                     onclick='selectNotebook(${n.id}, ${JSON.stringify(n.title)})'>
                    <div class="list-item-info">
                        <h4>${n.title}</h4>
                        <p>${n.description || 'No description'} ‚Ä¢ Created ${n.created_at}</p>
                    </div>
                </div>
            `).join('');

            const selectedExists = notebooks.some(nb => nb.id === selectedNotebookId);

            if (!preserveSelection || !selectedNotebookId || !selectedExists) {
                const firstNotebook = notebooks[0];
                if (firstNotebook) {
                    selectNotebook(firstNotebook.id, firstNotebook.title);
                }
            } else if (selectedNotebookId && selectedExists) {
                const currentNotebook = notebooks.find(nb => nb.id === selectedNotebookId);
                if (currentNotebook) {
                    selectNotebook(currentNotebook.id, currentNotebook.title);
                }
            }
        }

        function selectNotebook(notebookId, notebookTitle) {
            selectedNotebookId = notebookId;
            const notesWrapper = document.getElementById('notebookNotesWrapper');
            const clearBtn = document.getElementById('clearNotebookBtn');
            const selectedTitle = document.getElementById('selectedNotebookTitle');

            notesWrapper.classList.add('active');
            clearBtn.style.display = 'inline-flex';
            selectedTitle.textContent = notebookTitle;

            document.querySelectorAll('.notebook-item').forEach(item => {
                const itemId = parseInt(item.dataset.notebookId, 10);
                item.classList.toggle('active', itemId === notebookId);
            });

            loadNotebookNotes(notebookId);
        }

        function clearNotebookSelection() {
            selectedNotebookId = null;
            document.querySelectorAll('.notebook-item').forEach(item => item.classList.remove('active'));
            document.getElementById('notebookNotesWrapper').classList.remove('active');
            document.getElementById('clearNotebookBtn').style.display = 'none';
            document.getElementById('selectedNotebookTitle').textContent = '';
            document.getElementById('notebookNotesGrid').innerHTML = '';
            document.getElementById('notebookNotesEmpty').style.display = 'none';
        }

        async function loadNotebookNotes(notebookId) {
            const response = await fetch(`/api/notebooks/${notebookId}/notes`);
            const notes = await response.json();
            const grid = document.getElementById('notebookNotesGrid');
            const emptyState = document.getElementById('notebookNotesEmpty');

            if (notes.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            grid.innerHTML = notes.map(renderNoteCard).join('');
        }

        // Modal Functions
        function openNoteModal() {
            currentNoteId = null;
            document.getElementById('modalTitle').textContent = 'Create New Note';
            document.getElementById('noteForm').reset();
            document.getElementById('noteModal').classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
        }

        async function editNote(id) {
            currentNoteId = id;
            const response = await fetch(`/api/notes/${id}`);
            const note = await response.json();
            
            document.getElementById('modalTitle').textContent = 'Edit Note';
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteCategory').value = note.category_id || '';
            document.getElementById('noteNotebook').value = note.notebook_id || '';
            document.getElementById('noteTags').value = note.tags.join(', ');
            document.getElementById('notePublic').checked = note.is_public;
            document.getElementById('noteModal').classList.add('active');
        }

        // Form Submit (triggers trg_note_version on update, trg_notebook_updated)
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                title: document.getElementById('noteTitle').value,
                content: document.getElementById('noteContent').value,
                category_id: document.getElementById('noteCategory').value || null,
                notebook_id: document.getElementById('noteNotebook').value || null,
                tags: document.getElementById('noteTags').value.split(',').map(t => t.trim()).filter(t => t),
                is_public: document.getElementById('notePublic').checked ? 1 : 0
            };

            const url = currentNoteId ? `/api/notes/${currentNoteId}` : '/api/notes';
            const method = currentNoteId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            closeNoteModal();
            loadNotes();
            loadStats();
            
            // Show message if todo tag was added (trg_auto_todo_reminder)
            if (data.tags.includes('todo') && !currentNoteId) {
                setTimeout(() => {
                    alert('‚úì Note created with TODO tag! Auto-reminder created (Trigger: trg_auto_todo_reminder)');
                }, 500);
            }
            
            if (currentNoteId) {
                alert('‚úì Note updated! Version history saved (Trigger: trg_note_version)');
            }
        });

        // Other Functions
        async function deleteNote(id) {
            if (confirm('Are you sure you want to delete this note?')) {
                await fetch(`/api/notes/${id}`, { method: 'DELETE' });
                loadNotes();
                loadStats();
            }
        }

        async function toggleBookmark(id) {
            const response = await fetch(`/api/bookmarks/${id}`, { method: 'POST' });
            const result = await response.json();
            loadNotes();
            loadStats();
        }

        async function markReminderDone(id) {
            await fetch(`/api/reminders/${id}/done`, { method: 'POST' });
            loadReminders();
            loadStats();
            alert('‚úì Reminder marked as done! (Procedure: mark_reminder_done)');
        }
    </script>
</body>
</html>